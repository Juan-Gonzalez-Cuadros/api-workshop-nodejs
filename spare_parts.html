<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
    th{ 
        color:#fff;
            }
</style>

<div>
    <h1>Reporte de refacciones</h1>

    <a href="/success">Expedientes</a>
    <a href="/create_cone">Crear-Editar expediente</a>  
    <a href="/logout">Salir del sistema</a>  
</div>

<div class="row">
    <div class="col">
        <div class="card card-body">
            <input id="search-input" class="form-control" type="text">
        </div>
    </div>
</div>

<table class="table table-dark">
    <tr  class="bg-secondary">
        <th data-column="cone" data-order="desc">Expediente &#9650</th>
        <th data-column="description" data-order="desc">DescripciÃ³n &#9650</th>
        <th data-column="priority" data-order="desc">Prioridad &#9650</th>
        <th data-column="quantity" data-order="desc">Cantidad &#9650</th>
        <th data-column="status" data-order="desc">Estatus &#9650</th>
        <th data-column="supplier" data-order="desc">Proveedor &#9650</th>            
    </tr>

    <tbody id="myTableSP">
        
    </tbody>
</table>

<script>
	var myArray = []

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    console.log(queryString)
    if(urlParams.has('id')){
        const urlParamId = urlParams.get('id')
        $.ajax({
            method: 'GET',
            url: 'https://us-central1-workshop-688178.cloudfunctions.net/app/api/read_spare_parts',
            success: function(response){
                myArray = response
                var data = searchTable(urlParamId, myArray)
                buildTable(data)
            }
        })
    } else {
        $.ajax({
            method: 'GET',
            url: 'https://us-central1-workshop-688178.cloudfunctions.net/app/api/read_spare_parts',
            success: function(response){
                myArray = response
                buildTable(myArray)
            }
        })
    }

    $('th').on('click', function(){
        var column = $(this).data('column')
        var order = $(this).data('order')
        var text = $(this).html()
        text = text.substring(0, text.length -1)
        console.log(column, order, text)

        if(order == 'desc'){
            $(this).data('order', "asc")
            myArray = myArray.sort((a,b) => a.spare_part[column] > b.spare_part[column] ? 1 : -1)
            text += '&#9660'
        }else{
            $(this).data('order', "desc")
            myArray = myArray.sort((a,b) => a.spare_part[column] < b.spare_part[column] ? 1 : -1)
            text += '&#9650'
        }

        $(this).html(text)
        buildTable(myArray)
    })

    $('#search-input').on('keyup', function(){
        var value = $(this).val()

        $.ajax({
            method: 'GET',
            url: 'https://us-central1-workshop-688178.cloudfunctions.net/app/api/read_spare_parts',
            success: function(response){
                myArray = response
            }
        })

        var data = searchTable(value, myArray)
        buildTable(data)
    })

    function searchTable(value, data){
        var filteredData= []
        for (var i = 0; i < data.length; i++){
            value = value.toLowerCase()
            var cone = data[i].spare_part.cone.toLowerCase()
            var description = data[i].spare_part.description.toLowerCase()
            var priority = data[i].spare_part.priority.toLowerCase()
            var quantity = data[i].spare_part.quantity.toString()
            var status = data[i].spare_part.status.toLowerCase()
            var supplier = data[i].spare_part.supplier.toLowerCase()

            if(cone.includes(value)
            || description.includes(value)
            || priority.includes(value)
            || quantity.includes(value)
            || status.includes(value)
            || supplier.includes(value)
            ){
                filteredData.push(data[i])
            }

        }

        return filteredData
    }

	function buildTable(data){
		var table = document.getElementById('myTableSP')

        table.innerHTML = ''

		for (var i = 0; i < data.length; i++){
			var row = `<tr>
                        <td>${data[i].spare_part.cone}</td> 
                        <td>${data[i].spare_part.description}</td> 
                        <td>${data[i].spare_part.priority}</td> 
                        <td>${data[i].spare_part.quantity}</td> 
                        <td>${data[i].spare_part.status}</td> 
                        <td>${data[i].spare_part.supplier}</td> 
					  </tr>`
			table.innerHTML += row
		}
	}

</script>